import asyncio
import json
import logging

# é…ç½®æ—¥èªŒ
logging.basicConfig(
    level=logging.INFO, 
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

async def fake_stream(query: str):
    logger.info(f"é–‹å§‹è™•ç†æŸ¥è©¢: '{query}'")
    
    # Chunk 0: åˆå§‹æ€è€ƒæç¤º (Step 1)
    logger.debug("ç”Ÿæˆåˆå§‹æ€è€ƒæç¤º")
    yield json.dumps({
        "reasoning": [
            f"<step1> æ”¶åˆ°å•é¡Œï¼š{query}ï¼Œæ­£åœ¨é–‹å§‹åˆ†æã€‚é€™æ˜¯åˆå§‹éšæ®µï¼Œæˆ‘æ­£åœ¨æ•´ç†æ€è·¯ä»¥ä¾¿å¾ŒçºŒè™•ç†ã€‚"
        ],
        "finalized": False
    }, ensure_ascii=False) + "\n"
    await asyncio.sleep(2)
    logger.debug("åˆå§‹æ€è€ƒæç¤ºå·²ç”Ÿæˆ")
    
    # Chunk 1: éƒ¨åˆ†æ¨ç†æ­¥é©Ÿ1 (Step 2)
    logger.debug("ç”Ÿæˆéƒ¨åˆ†æ¨ç†æ­¥é©Ÿ1")
    yield json.dumps({
        "reasoning": [
            "<step2> ### æ­¥é©Ÿ1ï¼šè³‡æ–™åˆ†æ\n\n" +
            "åœ¨é€™ä¸€æ­¥ä¸­ï¼Œæˆ‘æœƒå…ˆæª¢æŸ¥ä¸¦æ•´ç†èˆ‡æŸ¥è©¢ç›¸é—œçš„è³‡æ–™ã€‚é€™åŒ…æ‹¬å¾å…§éƒ¨è³‡æ–™åº«æŠ½å–é—œéµå­—ã€æ¸…æ´—æ•¸æ“šä»¥åŠç¢ºå®šå“ªäº›è³‡è¨Šæ˜¯æœ€æœ‰åƒ¹å€¼çš„ã€‚ \n\n" +
            "è©³ç´°æ­¥é©Ÿå¦‚ä¸‹ï¼š\n" +
            "- **æ•¸æ“šæ¸…ç†**ï¼šå‰”é™¤ç„¡é—œæˆ–é‡è¤‡æ•¸æ“šï¼Œç¢ºä¿æ•¸æ“šçš„æº–ç¢ºæ€§ã€‚\n" +
            "- **æ ¼å¼é©—è­‰**ï¼šæª¢æŸ¥è³‡æ–™æ ¼å¼æ˜¯å¦ç¬¦åˆé æœŸï¼Œå°æ ¼å¼ä¸ç¬¦çš„è³‡æ–™é€²è¡Œä¿®æ­£ã€‚\n" +
            "- **ç•°å¸¸æª¢æ¸¬**ï¼šè­˜åˆ¥ä¸¦æ¨™è¨˜å¯èƒ½çš„ç•°å¸¸æ•¸æ“šï¼Œä»¥ä¾¿é€²ä¸€æ­¥è™•ç†ã€‚\n\n" +
            "å¾…è¾¦äº‹é …ï¼š\n" +
            "- [x] å°å…¥åŸå§‹æ•¸æ“š\n" +
            "- [ ] åŸ·è¡Œæ•¸æ“šè½‰æ›\n" +
            "- [ ] ç”Ÿæˆåˆæ­¥åˆ†æå ±å‘Š"
        ],
        "finalized": False
    }, ensure_ascii=False) + "\n"
    await asyncio.sleep(3)
    logger.debug("éƒ¨åˆ†æ¨ç†æ­¥é©Ÿ1å·²ç”Ÿæˆ")
    
    # Chunk 2: éƒ¨åˆ†æ¨ç†æ­¥é©Ÿ2 (Step 3)
    logger.debug("ç”Ÿæˆéƒ¨åˆ†æ¨ç†æ­¥é©Ÿ2")
    yield json.dumps({
        "reasoning": [
            "<step3> ### æ­¥é©Ÿ2ï¼šæŠ€è¡“ç´°ç¯€èˆ‡æ–¹æ³•èªªæ˜\n\n" +
            "åœ¨é€™ä¸€æ­¥ä¸­ï¼Œæˆ‘å°‡ä»‹ç´¹æ ¸å¿ƒçš„æŠ€è¡“ç´°ç¯€å’Œè™•ç†é‚è¼¯ã€‚é€™äº›æŠ€è¡“ç´°ç¯€å¹«åŠ©æˆ‘ç¢ºå®šæ•¸æ“šè™•ç†çš„æ–¹å‘ï¼Œä¸¦ä¿éšœæœ€çµ‚çµæœçš„æº–ç¢ºæ€§ã€‚ \n\n" +
            "å…·é«”èªªæ˜å¦‚ä¸‹ï¼š\n" +
            "> ğŸ’¡ **é‡è¦æç¤º**ï¼šä¸‹é¢å±•ç¤ºäº†æˆ‘è™•ç†è³‡æ–™çš„ä¸»è¦æ–¹æ³•ï¼Œä¸¦çµ¦å‡ºéƒ¨åˆ†ç¤ºä¾‹ä»£ç¢¼ä»¥ä¾¿åƒè€ƒã€‚\n\n" +
            "```python\n" +
            "def process_data(data):\n" +
            "    # æ­¤è™•åŸ·è¡Œæ•¸æ“šè™•ç†é‚è¼¯\n" +
            "    cleaned_data = clean_data(data)\n" +
            "    validated_data = validate_format(cleaned_data)\n" +
            "    result = analyze(validated_data)\n" +
            "    return result\n" +
            "```\n\n" +
            "æ­¤å¤–ï¼Œæˆ‘é‚„æœƒè¨ˆç®—é—œéµæ€§èƒ½æŒ‡æ¨™ï¼Œå¦‚æº–ç¢ºç‡ã€å¬å›ç‡åŠè™•ç†æ™‚é–“ï¼š\n\n" +
            "| æŒ‡æ¨™     | æ•¸å€¼ | ç›®æ¨™  |\n" +
            "|----------|------|-------|\n" +
            "| æº–ç¢ºç‡   | 95%  | 90%   |\n" +
            "| å¬å›ç‡   | 89%  | 85%   |\n" +
            "| è™•ç†æ™‚é–“ | 1.2s | 2.0s  |"
        ],
        "finalized": False
    }, ensure_ascii=False) + "\n"
    logger.debug("éƒ¨åˆ†æ¨ç†æ­¥é©Ÿ2å·²ç”Ÿæˆ")

    # Chunk 3: æœ€çµ‚ç­”æ¡ˆ (Step 4)
    logger.debug("ç”Ÿæˆæœ€çµ‚ç­”æ¡ˆ")
    yield json.dumps({
        "message": (
            "<step4> # åˆ†æå ±å‘Šèˆ‡çµè«–\n\n" +
            f"## æŸ¥è©¢ï¼š'{query}'\n\n" +
            "ç¶“éä¸Šè¿°æ­¥é©Ÿçš„æ•¸æ“šåˆ†æå’ŒæŠ€è¡“è™•ç†ï¼Œä»¥ä¸‹æ˜¯æˆ‘å°æŸ¥è©¢çš„ç¸½çµçµæœï¼š\n\n" +
            "### ä¸»è¦ç™¼ç¾\n\n" +
            "| é¡åˆ¥   | çµæœ   | å¯ä¿¡åº¦ |\n" +
            "|--------|--------|--------|\n" +
            "| é¡å‹A  | æ­£é¢   | é«˜     |\n" +
            "| é¡å‹B  | ä¸­æ€§   | ä¸­     |\n" +
            "| é¡å‹C  | å¾…å®š   | ä½     |\n\n" +
            "### è©³ç´°èªªæ˜\n\n" +
            "æ•¸æ“šåˆ†æè¡¨æ˜ï¼ŒæŸ¥è©¢çµæœä¸­å¤§éƒ¨åˆ†è³‡è¨Šéƒ½ç¬¦åˆé æœŸï¼Œä¸¦ä¸”æ€§èƒ½æŒ‡æ¨™é”åˆ°äº†æ—¢å®šç›®æ¨™ã€‚æŠ€è¡“ç´°ç¯€éƒ¨åˆ†ä¹Ÿå±•ç¤ºäº†æ•´é«”è™•ç†æµç¨‹å’Œçµæœçš„å¯é æ€§ã€‚\n\n" +
            "#### æŠ€è¡“ç´°ç¯€æ‘˜è¦\n\n" +
            "```json\n" +
            "{\n" +
            '    "status": "success",\n' +
            '    "version": "1.0.0",\n' +
            '    "timestamp": "2024-03-21"\n' +
            "}\n" +
            "```\n\n" +
            "å¦‚æœéœ€è¦æ›´æ·±å…¥çš„åˆ†ææˆ–é€²ä¸€æ­¥çš„æ•¸æ“šè§£è®€ï¼Œè«‹å‘ŠçŸ¥ï¼"
        ),
        "reasoning": [
            "<step4> ### æ­¥é©Ÿ3ï¼šæœ€çµ‚ç¸½çµèˆ‡å ±å‘Šç”Ÿæˆ\n\n" +
            "- æ•¸æ“šåˆ†æå·²å®Œæˆï¼Œæ€§èƒ½é”æ¨™ã€‚\n" +
            "- æ ¸å¿ƒè™•ç†é‚è¼¯åŠæŠ€è¡“ç´°ç¯€æ¸…æ™°ã€‚\n" +
            "- å ±å‘Šç”Ÿæˆä¸¦æ•´åˆäº†æ‰€æœ‰åˆ†æçµæœã€‚"
        ],
        "finalized": True
    }, ensure_ascii=False) + "\n"
    logger.info(f"æŸ¥è©¢ '{query}' è™•ç†å®Œæˆ")
    
    return  # çµæŸç”Ÿæˆå™¨

# æ¸¬è©¦ä½¿ç”¨ï¼ˆéœ€è¦åœ¨ async ç’°å¢ƒä¸­é‹è¡Œï¼‰
# async def main():
#     async for chunk in fake_stream("æ¸¬è©¦æŸ¥è©¢"):
#         print(chunk)
#
# asyncio.run(main())
